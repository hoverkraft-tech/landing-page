# Workflow to automatically generate blog posts summarizing new releases from all Hoverkraft Tech public repositories.
# The workflow automatically handles content generation, no manual intervention needed unless the preview image generation fails.

#
# The workflow uses modular GitHub Actions following SOLID principles:
#
# - [fetch-releases](./.github/actions/fetch-releases/action.yml): Fetches releases from GitHub API
# - [generate-blog-post](./.github/actions/generate-blog-post/README.md): Generates AI-powered blog content
---
name: Generate Release Blog Post

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      #checkov:skip=CKV_GHA_7: required
      since-date:
        description: "Fetch releases since this date (ISO 8601 format, e.g., 2025-01-01T00:00:00Z)"
        required: false
        type: string
      until-date:
        description: "Fetch releases until this date (ISO 8601 format, e.g., 2025-01-15T23:59:59Z)"
        required: false
        type: string

permissions: {}

jobs:
  generate-blog-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Calculate date range
        id: dates
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          SINCE_INPUT: ${{ inputs.since-date }}
          UNTIL_INPUT: ${{ inputs.until-date }}
        with:
          script: |
            let sinceDate, untilDate;

            if (process.env.SINCE_INPUT) {
              sinceDate = new Date(process.env.SINCE_INPUT);
            } else {
              // Default: 7 days ago
              sinceDate = new Date();
              sinceDate.setDate(sinceDate.getDate() - 7);
            }

            if (process.env.UNTIL_INPUT) {
              untilDate = new Date(process.env.UNTIL_INPUT);
            } else {
              // Default: now
              untilDate = new Date();
            }

            core.setOutput('since-date', sinceDate.toISOString());
            core.setOutput('until-date', untilDate.toISOString());
            core.info(`Date range: ${sinceDate.toISOString()} to ${untilDate.toISOString()}`);

      - name: Generate token for blog post creation
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: generate-token
        with:
          app-id: ${{ vars.CI_BOT_APP_ID }}
          private-key: ${{ secrets.CI_BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Fetch releases
        id: fetch-releases
        uses: ./.github/actions/fetch-releases
        with:
          since-date: ${{ steps.dates.outputs.since-date }}
          until-date: ${{ steps.dates.outputs.until-date }}
          github-token: ${{ steps.generate-token.outputs.token }}

      - name: Generate blog post
        if: steps.fetch-releases.outputs.releases-data
        id: generate
        uses: ./.github/actions/generate-blog-post
        with:
          releases-data: ${{ steps.fetch-releases.outputs.releases-data }}
          since-date: ${{ steps.dates.outputs.since-date }}
          until-date: ${{ steps.dates.outputs.until-date }}
          openai-api-key: ${{ secrets.COPILOT_MCP_OPENAI_API_KEY }}
          output-dir: application

      - name: Create pull request
        if: steps.fetch-releases.outputs.releases-data
        uses: hoverkraft-tech/ci-github-common/actions/create-and-merge-pull-request@b17226e57c8ef31f860719766656ebb6df017218 # 0.31.6
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          branch: blog/releases-${{ steps.generate.outputs.slug }}
          commit-message: |
            feat: add blog post for releases ${{ steps.generate.outputs.slug }}

            Automatically generated blog post summarizing releases from ${{ steps.dates.outputs.since-date }} to ${{ steps.dates.outputs.until-date }}.
          title: "feat: Blog post - Release summary ${{ steps.generate.outputs.slug }}"
          body: |
            ## Generated Blog Post: Release Summary ðŸš€

            This PR contains an automatically generated blog post summarizing the latest releases from ${{ github.repository_owner }} public repositories.

            **Period**: ${{ steps.dates.outputs.since-date }} to ${{ steps.dates.outputs.until-date }}
            **Slug**: `${{ steps.generate.outputs.slug }}`
