# Workflow to automatically generate blog posts summarizing new releases
# from all Hoverkraft Tech public repositories.
#
# This workflow runs on a monthly schedule and checks for new releases
# since the last check. When releases are found, it uses the blog-post
# custom agent (via Copilot) to generate bilingual blog content and creates a PR.

---
name: Generate Release Blog Post

on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC
    - cron: "0 9 1 * *"
  workflow_dispatch:
    inputs:
      since-date:
        description: "Fetch releases since this date (ISO 8601 format, e.g., 2025-01-01T00:00:00Z)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-and-generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"

      - name: Check for new releases
        id: check
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          SINCE_DATE_INPUT: ${{ inputs.since-date }}
        with:
          script: |
            const owner = 'hoverkraft-tech';

            // Determine the date range
            let sinceDate;
            if (process.env.SINCE_DATE_INPUT) {
              sinceDate = new Date(process.env.SINCE_DATE_INPUT);
            } else {
              // Default: last 30 days
              sinceDate = new Date();
              sinceDate.setDate(sinceDate.getDate() - 30);
            }

            const untilDate = new Date();

            core.info(`Checking for releases from ${sinceDate.toISOString()} to ${untilDate.toISOString()}`);

            // Get all public repos for the organization
            const repos = await github.paginate(github.rest.repos.listForOrg, {
              org: owner,
              type: 'public',
              per_page: 100
            });

            core.info(`Found ${repos.length} public repositories`);

            // Fetch releases for each repo
            const releasesData = [];

            for (const repo of repos) {
              try {
                const releases = await github.paginate(github.rest.repos.listReleases, {
                  owner,
                  repo: repo.name,
                  per_page: 100
                });
                
                // Filter releases by date
                const recentReleases = releases.filter(release => {
                  const publishedAt = new Date(release.published_at);
                  return publishedAt >= sinceDate && publishedAt <= untilDate && !release.draft;
                });
                
                if (recentReleases.length > 0) {
                  core.info(`Found ${recentReleases.length} release(s) for ${repo.name}`);
                  
                  releasesData.push({
                    repo: repo.name,
                    description: repo.description,
                    url: repo.html_url,
                    stars: repo.stargazers_count,
                    releases: recentReleases.map(r => ({
                      name: r.name,
                      tag: r.tag_name,
                      publishedAt: r.published_at,
                      url: r.html_url,
                      body: r.body
                    }))
                  });
                }
              } catch (error) {
                core.warning(`Failed to fetch releases for ${repo.name}: ${error.message}`);
              }
            }

            core.setOutput('has-releases', releasesData.length > 0 ? 'true' : 'false');
            core.setOutput('releases-data', JSON.stringify(releasesData));
            core.setOutput('since-date', sinceDate.toISOString());
            core.setOutput('until-date', untilDate.toISOString());

            if (releasesData.length === 0) {
              core.info('No new releases found in the specified period');
            } else {
              core.info(`Found releases from ${releasesData.length} repositories`);
            }

      - name: Generate blog post files
        if: steps.check.outputs.has-releases == 'true'
        run: |
          chmod +x .github/scripts/generate-release-blog-post.js
          .github/scripts/generate-release-blog-post.js
        env:
          RELEASES_DATA: ${{ steps.check.outputs.releases-data }}
          SINCE_DATE: ${{ steps.check.outputs.since-date }}
          UNTIL_DATE: ${{ steps.check.outputs.until-date }}
          OPENAI_API_KEY: ${{ secrets.COPILOT_MCP_OPENAI_API_KEY }}

      - name: Generate slug for outputs
        if: steps.check.outputs.has-releases == 'true'
        id: generate-slug
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          UNTIL_DATE: ${{ steps.check.outputs.until-date }}
        with:
          script: |
            const untilDate = new Date(process.env.UNTIL_DATE);
            const year = untilDate.getFullYear();
            const month = String(untilDate.getMonth() + 1).padStart(2, '0');
            const slug = `releases-${year}-${month}`;
            core.setOutput('slug', slug);
            core.setOutput('year', year);
            core.setOutput('month', month);

      - uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        if: steps.check.outputs.has-releases == 'true'
        id: generate-token
        with:
          app-id: ${{ vars.CI_BOT_APP_ID }}
          private-key: ${{ secrets.CI_BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Create pull request
        if: steps.check.outputs.has-releases == 'true'
        uses: hoverkraft-tech/ci-github-common/actions/create-and-merge-pull-request@5f11437c716059f30c635f90055060e4ef8b31a0 # 0.28.0
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          branch: blog/releases-${{ steps.generate-slug.outputs.slug }}
          commit-message: |
            feat: add blog post for releases ${{ steps.generate-slug.outputs.slug }}

            Automatically generated blog post summarizing releases from ${{ steps.check.outputs.since-date }} to ${{ steps.check.outputs.until-date }}.
          title: "feat: Blog post - Release summary ${{ steps.generate-slug.outputs.year }}-${{ steps.generate-slug.outputs.month }}"
          body: |
            ## New Blog Post: Release Summary ðŸš€

            This PR adds a bilingual blog post summarizing the latest releases from Hoverkraft Tech public repositories.

            **Period**: ${{ steps.check.outputs.since-date }} to ${{ steps.check.outputs.until-date }}

            ### Files Created
            - `application/src/data/post/${{ steps.generate-slug.outputs.slug }}/common.yaml`
            - `application/src/data/post/${{ steps.generate-slug.outputs.slug }}/fr.mdx`
            - `application/src/data/post/${{ steps.generate-slug.outputs.slug }}/en.mdx`

            ### âš ï¸ Action Required
            A preview image needs to be added at:
            `application/src/assets/images/blog/${{ steps.generate-slug.outputs.slug }}/preview.png`

            You can use the blog-post custom agent or another image generation tool to create it.

            ---

            This blog post was automatically generated by the `generate-release-blog-post` workflow.

      - name: Create summary
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          HAS_RELEASES: ${{ steps.check.outputs.has-releases }}
          SINCE_DATE: ${{ steps.check.outputs.since-date }}
          UNTIL_DATE: ${{ steps.check.outputs.until-date }}
          RELEASES_DATA: ${{ steps.check.outputs.releases-data }}
        with:
          script: |
            const hasReleases = process.env.HAS_RELEASES === 'true';

            if (!hasReleases) {
              await core.summary
                .addHeading('No New Releases Found', 2)
                .addRaw(`No new releases were found from ${process.env.SINCE_DATE} to ${process.env.UNTIL_DATE}.`)
                .write();
            } else {
              const releasesData = JSON.parse(process.env.RELEASES_DATA || '[]');
              const totalReleases = releasesData.reduce((sum, r) => sum + r.releases.length, 0);
              
              await core.summary
                .addHeading('Release Blog Post Created âœ…', 2)
                .addTable([
                  [{ data: 'Period', header: true }, `${process.env.SINCE_DATE} to ${process.env.UNTIL_DATE}`],
                  [{ data: 'Repositories', header: true }, String(releasesData.length)],
                  [{ data: 'Total Releases', header: true }, String(totalReleases)]
                ])
                .addHeading('Next Steps', 3)
                .addList([
                  'A pull request has been created with the blog post',
                  'Add a preview image to the blog post',
                  'Review the content and merge when ready'
                ])
                .write();
            }
