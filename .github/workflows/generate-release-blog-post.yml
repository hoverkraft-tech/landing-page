# Workflow to automatically generate blog posts summarizing new releases
# from all Hoverkraft Tech public repositories.

---
name: Generate Release Blog Post

on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC
    - cron: "0 9 1 * *"
  workflow_dispatch:
    inputs:
      since-date:
        description: "Fetch releases since this date (ISO 8601 format, e.g., 2025-01-01T00:00:00Z)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-blog-post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcb5dd907a8 # v5.0.0

      - name: Fetch releases
        id: fetch-releases
        uses: ./.github/actions/fetch-releases
        with:
          since-date: ${{ inputs.since-date }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate blog post
        if: steps.fetch-releases.outputs.has-releases == 'true'
        id: generate
        uses: ./.github/actions/generate-blog-post
        with:
          releases-data: ${{ steps.fetch-releases.outputs.releases-data }}
          since-date: ${{ steps.fetch-releases.outputs.since-date }}
          until-date: ${{ steps.fetch-releases.outputs.until-date }}
          openai-api-key: ${{ secrets.COPILOT_MCP_OPENAI_API_KEY }}
          output-dir: application

      - name: Generate token for PR creation
        if: steps.fetch-releases.outputs.has-releases == 'true'
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: generate-token
        with:
          app-id: ${{ vars.CI_BOT_APP_ID }}
          private-key: ${{ secrets.CI_BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Create pull request
        if: steps.fetch-releases.outputs.has-releases == 'true'
        uses: hoverkraft-tech/ci-github-common/actions/create-and-merge-pull-request@5f11437c716059f30c635f90055060e4ef8b31a0 # 0.28.0
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          branch: blog/releases-${{ steps.generate.outputs.slug }}
          commit-message: |
            feat: add blog post for releases ${{ steps.generate.outputs.slug }}

            Automatically generated blog post summarizing releases from ${{ steps.fetch-releases.outputs.since-date }} to ${{ steps.fetch-releases.outputs.until-date }}.
          title: "feat: Blog post - Release summary ${{ steps.generate.outputs.slug }}"
          body: |
            ## New Blog Post: Release Summary üöÄ

            This PR adds an AI-generated bilingual blog post summarizing the latest releases from Hoverkraft Tech public repositories.

            **Period**: ${{ steps.fetch-releases.outputs.since-date }} to ${{ steps.fetch-releases.outputs.until-date }}

            ### Files Created
            - `${{ steps.generate.outputs.post-dir }}/common.yaml`
            - `${{ steps.generate.outputs.post-dir }}/fr.mdx`
            - `${{ steps.generate.outputs.post-dir }}/en.mdx`
            - Preview image: ${{ steps.generate.outputs.image-generated == 'true' && '‚úÖ Generated' || '‚ö†Ô∏è Needs manual addition' }}

            ### Review Checklist
            - [ ] Content is accurate and engaging
            - [ ] Preview image is appropriate
            - [ ] Links work correctly
            - [ ] No sensitive information leaked

            ---

            This blog post was automatically generated by the `generate-release-blog-post` workflow using OpenAI.

      - name: Create summary
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          HAS_RELEASES: ${{ steps.fetch-releases.outputs.has-releases }}
          SINCE_DATE: ${{ steps.fetch-releases.outputs.since-date }}
          UNTIL_DATE: ${{ steps.fetch-releases.outputs.until-date }}
          SLUG: ${{ steps.generate.outputs.slug }}
          IMAGE_GENERATED: ${{ steps.generate.outputs.image-generated }}
        with:
          script: |
            const hasReleases = process.env.HAS_RELEASES === 'true';

            if (!hasReleases) {
              await core.summary
                .addHeading('No New Releases Found', 2)
                .addRaw(`No new releases were found from ${process.env.SINCE_DATE} to ${process.env.UNTIL_DATE}.`)
                .write();
            } else {
              const imageStatus = process.env.IMAGE_GENERATED === 'true' ? '‚úÖ Generated' : '‚ö†Ô∏è Manual addition needed';

              await core.summary
                .addHeading('Release Blog Post Created ‚úÖ', 2)
                .addTable([
                  [{ data: 'Period', header: true }, `${process.env.SINCE_DATE} to ${process.env.UNTIL_DATE}`],
                  [{ data: 'Slug', header: true }, process.env.SLUG],
                  [{ data: 'Preview Image', header: true }, imageStatus]
                ])
                .addHeading('Next Steps', 3)
                .addList([
                  'A pull request has been created with the AI-generated blog post',
                  'Review the content for accuracy and appropriateness',
                  'Merge when ready'
                ])
                .write();
            }
