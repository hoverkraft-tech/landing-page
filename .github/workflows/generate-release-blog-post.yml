# Workflow to automatically generate blog posts summarizing new releases
# from all Hoverkraft Tech public repositories.

---
name: Generate Release Blog Post

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      since-date:
        description: "Fetch releases since this date (ISO 8601 format, e.g., 2025-01-01T00:00:00Z)"
        required: false
        type: string
      until-date:
        description: "Fetch releases until this date (ISO 8601 format, e.g., 2025-01-15T23:59:59Z)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-blog-post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcb5dd907a8 # v5.0.0

      - name: Calculate date range
        id: dates
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          SINCE_INPUT: ${{ inputs.since-date }}
          UNTIL_INPUT: ${{ inputs.until-date }}
        with:
          script: |
            let sinceDate, untilDate;

            if (process.env.SINCE_INPUT) {
              sinceDate = new Date(process.env.SINCE_INPUT);
            } else {
              // Default: 7 days ago
              sinceDate = new Date();
              sinceDate.setDate(sinceDate.getDate() - 7);
            }

            if (process.env.UNTIL_INPUT) {
              untilDate = new Date(process.env.UNTIL_INPUT);
            } else {
              // Default: now
              untilDate = new Date();
            }

            core.setOutput('since-date', sinceDate.toISOString());
            core.setOutput('until-date', untilDate.toISOString());
            core.info(`Date range: ${sinceDate.toISOString()} to ${untilDate.toISOString()}`);

      - name: Fetch releases
        id: fetch-releases
        uses: ./.github/actions/fetch-releases
        with:
          since-date: ${{ steps.dates.outputs.since-date }}
          until-date: ${{ steps.dates.outputs.until-date }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if releases found
        id: check-releases
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          RELEASES_DATA: ${{ steps.fetch-releases.outputs.releases-data }}
        with:
          script: |
            const releasesData = JSON.parse(process.env.RELEASES_DATA);
            const hasReleases = releasesData && releasesData.length > 0;
            core.setOutput('has-releases', hasReleases ? 'true' : 'false');
            core.info(`Has releases: ${hasReleases}`);

      - name: Generate blog post
        if: steps.check-releases.outputs.has-releases == 'true'
        id: generate
        uses: ./.github/actions/generate-blog-post
        with:
          releases-data: ${{ steps.fetch-releases.outputs.releases-data }}
          since-date: ${{ steps.dates.outputs.since-date }}
          until-date: ${{ steps.dates.outputs.until-date }}
          openai-api-key: ${{ secrets.COPILOT_MCP_OPENAI_API_KEY }}
          output-dir: application

      - name: Generate token for PR creation
        if: steps.check-releases.outputs.has-releases == 'true'
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: generate-token
        with:
          app-id: ${{ vars.CI_BOT_APP_ID }}
          private-key: ${{ secrets.CI_BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Create pull request
        if: steps.check-releases.outputs.has-releases == 'true'
        uses: hoverkraft-tech/ci-github-common/actions/create-and-merge-pull-request@5f11437c716059f30c635f90055060e4ef8b31a0 # 0.28.0
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          branch: blog/releases-${{ steps.generate.outputs.slug }}
          commit-message: |
            feat: add blog post for releases ${{ steps.generate.outputs.slug }}

            Automatically generated blog post summarizing releases from ${{ steps.dates.outputs.since-date }} to ${{ steps.dates.outputs.until-date }}.
          title: "feat: Blog post - Release summary ${{ steps.generate.outputs.slug }}"
          body: |
            ## AI-Generated Blog Post: Release Summary ðŸš€

            This PR contains an automatically generated bilingual blog post summarizing the latest releases from Hoverkraft Tech public repositories.

            **Period**: ${{ steps.dates.outputs.since-date }} to ${{ steps.dates.outputs.until-date }}
            **Slug**: `${{ steps.generate.outputs.slug }}`

            ### Files Created
            - `application/src/data/post/${{ steps.generate.outputs.slug }}/common.yaml`
            - `application/src/data/post/${{ steps.generate.outputs.slug }}/fr.mdx`
            - `application/src/data/post/${{ steps.generate.outputs.slug }}/en.mdx`
            - Preview image: âœ… Generated with DALL-E 3

            ---

            **ðŸ¤– Auto-Merge**: This PR will be automatically merged once all CI checks pass.

            Generated by the `generate-release-blog-post` workflow using OpenAI GPT-4o-mini and DALL-E 3.

      - name: Create summary
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          HAS_RELEASES: ${{ steps.check-releases.outputs.has-releases }}
          SINCE_DATE: ${{ steps.dates.outputs.since-date }}
          UNTIL_DATE: ${{ steps.dates.outputs.until-date }}
          SLUG: ${{ steps.generate.outputs.slug }}
        with:
          script: |
            const hasReleases = process.env.HAS_RELEASES === 'true';

            if (!hasReleases) {
              await core.summary
                .addHeading('No New Releases Found', 2)
                .addRaw(`No new releases were found from ${process.env.SINCE_DATE} to ${process.env.UNTIL_DATE}.`)
                .write();
            } else {
              await core.summary
                .addHeading('Release Blog Post Created âœ…', 2)
                .addTable([
                  [{ data: 'Period', header: true }, `${process.env.SINCE_DATE} to ${process.env.UNTIL_DATE}`],
                  [{ data: 'Slug', header: true }, process.env.SLUG],
                  [{ data: 'Preview Image', header: true }, 'âœ… Generated with DALL-E 3']
                ])
                .addHeading('Next Steps', 3)
                .addList([
                  'A pull request has been created with the AI-generated blog post',
                  'The PR will be automatically merged once all CI checks pass',
                  'Monitor the CI checks to ensure everything builds correctly'
                ])
                .write();
            }
