name: Fetch Branding Assets

# This workflow fetches branding assets from the @hoverkraft-tech/branding repository
# (https://github.com/hoverkraft-tech/branding) at build time to ensure the landing
# page always has up-to-date brand resources.
# It runs before the main build process to prepare assets for deployment.

on:
  workflow_call:
    inputs:
      branding-repo:
        description: 'Branding repository to fetch from'
        required: false
        default: 'hoverkraft-tech/branding'
        type: string
      branding-ref:
        description: 'Git ref (tag, branch, or commit SHA) to fetch'
        required: false
        default: 'main'
        type: string
      target-dir:
        description: 'Target directory for branding assets'
        required: false
        default: 'application/src/data/brand'
        type: string

permissions:
  contents: read

jobs:
  fetch-branding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch branding assets
        uses: ./.github/actions/fetch-branding-assets
        with:
          branding-repo: ${{ inputs.branding-repo }}
          branding-ref: ${{ inputs.branding-ref }}
          target-dir: ${{ inputs.target-dir }}
          github-token: ${{ github.token }}

      - name: Create logo pack
        uses: ./.github/actions/create-logo-pack

      - name: Setup Node.js for build tools
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'application/package-lock.json'

      - name: Install dependencies
        run: |
          cd application
          npm ci

      - name: Parse brand colors
        uses: ./.github/actions/parse-brand-colors
        with:
          colors-file: ${{ inputs.target-dir }}/colors.css
          output-file: ${{ inputs.target-dir }}/generated-colors.ts

      - name: Generate brand guidelines PDF
        uses: ./.github/actions/generate-brand-pdf
        with:
          page-url: 'http://localhost:4321/charte-graphique'
          output-file: 'application/public/brand/downloads/hoverkraft-brand-guidelines.pdf'
          working-directory: 'application'

      - name: Validate assets
        run: |
          echo "Validating branding assets..."

          # Check for required files
          MISSING_ASSETS=()

          # Check for colors.css
          if [ ! -f "${{ inputs.target-dir }}/colors.css" ]; then
            MISSING_ASSETS+=("colors.css")
          fi

          # Check for at least one logo
          if [ ! -d "application/public/brand/logos" ] || [ -z "$(ls -A application/public/brand/logos)" ]; then
            MISSING_ASSETS+=("logos")
          fi

          # Check for logo pack
          if [ ! -f "application/public/brand/downloads/hoverkraft-logos.zip" ]; then
            MISSING_ASSETS+=("hoverkraft-logos.zip")
          fi

          # Check for generated PDF
          if [ ! -f "application/public/brand/downloads/hoverkraft-brand-guidelines.pdf" ]; then
            MISSING_ASSETS+=("hoverkraft-brand-guidelines.pdf")
          fi

          if [ ${#MISSING_ASSETS[@]} -gt 0 ]; then
            echo "::warning::Missing optional branding assets: ${MISSING_ASSETS[*]}"
            echo "Build will continue with fallback assets"
          else
            echo "âœ“ All required branding assets are present"
          fi

      - name: Upload fetched assets as artifact
        uses: actions/upload-artifact@v4
        with:
          name: branding-assets
          path: |
            ${{ inputs.target-dir }}
            application/public/brand/
          retention-days: 1

