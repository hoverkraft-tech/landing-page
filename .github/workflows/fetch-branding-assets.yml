name: Fetch Branding Assets

# This workflow fetches branding assets from the @hoverkraft-tech/branding repository
# (https://github.com/hoverkraft-tech/branding) at build time to ensure the landing
# page always has up-to-date brand resources.
# It runs before the main build process to prepare assets for deployment.

on:
  workflow_call:
    inputs:
      branding-repo:
        description: 'Branding repository to fetch from'
        required: false
        default: 'hoverkraft-tech/branding'
        type: string
      branding-ref:
        description: 'Git ref (tag, branch, or commit SHA) to fetch'
        required: false
        default: 'main'
        type: string
      target-dir:
        description: 'Target directory for branding assets'
        required: false
        default: 'application/src/data/brand'
        type: string

permissions:
  contents: read

jobs:
  fetch-branding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if branding repo is accessible
        id: check-repo
        continue-on-error: true
        run: |
          # Check if the branding repository is accessible
          # Note: The repository exists at https://github.com/hoverkraft-tech/branding
          # but may be private and require proper authentication
          if gh repo view ${{ inputs.branding-repo }} &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Cannot access branding repository '${{ inputs.branding-repo }}'. It may be private or you may not have permission. Skipping asset fetch."
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Fetch branding assets
        if: steps.check-repo.outputs.exists == 'true'
        run: |
          echo "Fetching branding assets from ${{ inputs.branding-repo }} at ref ${{ inputs.branding-ref }}"

          # Create temporary directory for cloning
          TEMP_DIR=$(mktemp -d)

          # Clone the branding repository at specified ref
          git clone --depth 1 --branch ${{ inputs.branding-ref }} \
            https://github.com/${{ inputs.branding-repo }}.git "$TEMP_DIR"

          # Create target directories
          mkdir -p ${{ inputs.target-dir }}
          mkdir -p application/public/brand/logos
          mkdir -p application/public/brand/downloads

          # Fetch colors.css (brand colors)
          if [ -f "$TEMP_DIR/colors.css" ]; then
            cp "$TEMP_DIR/colors.css" ${{ inputs.target-dir }}/colors.css
            echo "✓ Copied brand colors (colors.css)"
          else
            echo "::warning::colors.css not found in branding repository"
          fi

          # Fetch logos from logo/ directory
          if [ -d "$TEMP_DIR/logo" ]; then
            cp -r "$TEMP_DIR/logo/"* application/public/brand/logos/
            echo "✓ Copied brand logos"
          else
            echo "::warning::logo/ directory not found in branding repository"
          fi

          # Fetch mascot
          if [ -f "$TEMP_DIR/mascot/mascot.png" ]; then
            mkdir -p application/public/brand/mascot
            cp "$TEMP_DIR/mascot/mascot.png" application/public/brand/mascot/
            echo "✓ Copied mascot"
          else
            echo "::warning::mascot/mascot.png not found in branding repository"
          fi

          # Fetch branding guideline PDF
          if [ -f "$TEMP_DIR/branding-guideline-pdf" ]; then
            cp "$TEMP_DIR/branding-guideline-pdf" application/public/brand/downloads/hoverkraft-brand-guidelines.pdf
            echo "✓ Copied branding guideline PDF"
          else
            echo "::warning::branding-guideline-pdf not found in branding repository"
          fi

          # Clean up
          rm -rf "$TEMP_DIR"

          echo "Branding assets fetched successfully from ${{ inputs.branding-ref }}"

      - name: Create logo pack
        if: steps.check-repo.outputs.exists == 'true'
        run: |
          echo "Creating logo pack ZIP..."
          
          # Create logo pack from fetched logos
          if [ -d "application/public/brand/logos" ] && [ "$(ls -A application/public/brand/logos)" ]; then
            cd application/public/brand/logos
            zip -r ../downloads/hoverkraft-logos.zip . -i "*.svg" "*.png" "*.pdf"
            cd -
            echo "✓ Created logo pack: hoverkraft-logos.zip"
            
            # List contents for verification
            echo "Logo pack contents:"
            unzip -l application/public/brand/downloads/hoverkraft-logos.zip
          else
            echo "::warning::No logos found to create logo pack"
          fi

      - name: Setup Node.js
        if: steps.check-repo.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Parse brand colors
        if: steps.check-repo.outputs.exists == 'true'
        run: |
          echo "Parsing brand colors from colors.css..."
          cd application
          if [ -f "src/data/brand/colors.css" ]; then
            node scripts/parse-brand-colors.mjs
          else
            echo "::warning::colors.css not found, using fallback colors"
          fi

      - name: Validate assets
        if: steps.check-repo.outputs.exists == 'true'
        run: |
          echo "Validating branding assets..."

          # Check for required files
          MISSING_ASSETS=()

          # Check for colors.css
          if [ ! -f "${{ inputs.target-dir }}/colors.css" ]; then
            MISSING_ASSETS+=("colors.css")
          fi

          # Check for at least one logo
          if [ ! -d "application/public/brand/logos" ] || [ -z "$(ls -A application/public/brand/logos)" ]; then
            MISSING_ASSETS+=("logos")
          fi

          # Check for logo pack
          if [ ! -f "application/public/brand/downloads/hoverkraft-logos.zip" ]; then
            MISSING_ASSETS+=("hoverkraft-logos.zip")
          fi

          if [ ${#MISSING_ASSETS[@]} -gt 0 ]; then
            echo "::warning::Missing optional branding assets: ${MISSING_ASSETS[*]}"
            echo "Build will continue with fallback assets"
          else
            echo "✓ All required branding assets are present"
          fi

      - name: Upload fetched assets as artifact
        if: steps.check-repo.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: branding-assets
          path: |
            ${{ inputs.target-dir }}
            application/src/assets/brand/
          retention-days: 1
