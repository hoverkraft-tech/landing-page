name: ðŸš€ Release

on:
  push:
    branches: [main]

jobs:
  ci:
    name: Continuous Integration
    uses: ./.github/workflows/__shared-ci.yml

  release:
    needs: ci
    runs-on: "ubuntu-latest"
    environment: github-pages
    steps:
      - uses: escemi-tech/actions-node@v1.10.0

      - name: ðŸš€ Release to GitHub Pages
        uses: crazy-max/ghaction-github-pages@v3
        with:
          target_branch: gh-pages
          build_dir: public
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”­ Check the site is up
        uses: jtalk/url-health-check-action@v2
        with:
          url: "${{ secrets.SITE_URL }}"

      - name: ðŸš¦ Audit URLs using Lighthouse
        id: lighthouse-ci-audit
        uses: treosh/lighthouse-ci-action@9.3.0
        with:
          urls: ${{ secrets.SITE_URL }}
          temporaryPublicStorage: true

      - name: ðŸš¦ Update Lighthouse badge
        uses: ./github/actions/lighthouse-badge
        with:
            links: ${{ steps.lighthouse-ci-audit.outputs.links }}
            manifest: ${{ steps.lighthouse-ci-audit.outputs.manifest }}