name: Update Branding Assets

# This workflow is triggered by the branding repository via repository dispatch
# when new branding data is available. It receives a manifest and artifact ID,
# downloads the assets, and updates the landing page accordingly.

on:
  repository_dispatch:
    types: [branding-update]
  workflow_dispatch:
    inputs:
      artifact-id:
        description: 'GitHub artifact ID containing branding assets'
        required: true
        type: string
      manifest:
        description: 'JSON manifest describing the branding data'
        required: true
        type: string

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  update-branding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Parse manifest from dispatch
        id: parse-manifest
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            let manifest, artifactId;
            
            if (context.eventName === 'repository_dispatch') {
              manifest = context.payload.client_payload.manifest;
              artifactId = context.payload.client_payload.artifact_id;
            } else {
              manifest = JSON.parse(process.env.MANIFEST_INPUT);
              artifactId = process.env.ARTIFACT_ID_INPUT;
            }
            
            core.setOutput('manifest', JSON.stringify(manifest));
            core.setOutput('artifact_id', artifactId);
            core.setOutput('version', manifest.version);
            core.setOutput('commit', manifest.commit);
            
            core.info(`ðŸ“¦ Branding update received:`);
            core.info(`  Version: ${manifest.version}`);
            core.info(`  Commit: ${manifest.commit}`);
            core.info(`  Artifact ID: ${artifactId}`);
        env:
          MANIFEST_INPUT: ${{ inputs.manifest }}
          ARTIFACT_ID_INPUT: ${{ inputs.artifact-id }}

      - name: Validate manifest against schema
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const Ajv = require('ajv');
            const addFormats = require('ajv-formats');
            
            const manifest = JSON.parse(process.env.MANIFEST);
            const schema = JSON.parse(fs.readFileSync('.github/schemas/branding-manifest.schema.json', 'utf8'));
            
            const ajv = new Ajv();
            addFormats(ajv);
            
            const validate = ajv.compile(schema);
            const valid = validate(manifest);
            
            if (!valid) {
              core.setFailed(`Manifest validation failed: ${JSON.stringify(validate.errors, null, 2)}`);
            } else {
              core.info('âœ“ Manifest validation passed');
            }
        env:
          MANIFEST: ${{ steps.parse-manifest.outputs.manifest }}

      - name: Download branding artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: branding-assets-${{ steps.parse-manifest.outputs.artifact_id }}
          path: /tmp/branding-assets
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: hoverkraft-tech/branding
          run-id: ${{ steps.parse-manifest.outputs.artifact_id }}

      - name: Extract and organize assets
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const manifest = JSON.parse(process.env.MANIFEST);
            
            // Create target directories
            const dirs = [
              'application/src/data/brand',
              'application/public/brand/logos',
              'application/public/brand/mascot',
              'application/public/brand/downloads'
            ];
            
            dirs.forEach(dir => {
              if (!fs.existsSync(dir)) {
                fs.mkdirSync(dir, { recursive: true });
              }
            });
            
            // Copy logos based on manifest paths
            manifest.logos.forEach(logo => {
              const sourcePath = path.join('/tmp/branding-assets', logo.path);
              const targetPath = path.join('application/public/brand', logo.path);
              
              if (fs.existsSync(sourcePath)) {
                const targetDir = path.dirname(targetPath);
                if (!fs.existsSync(targetDir)) {
                  fs.mkdirSync(targetDir, { recursive: true });
                }
                fs.copyFileSync(sourcePath, targetPath);
                core.info(`âœ“ Copied logo: ${logo.path}`);
              } else {
                core.warning(`Logo file not found: ${logo.path}`);
              }
            });
            
            // Copy mascot (if present)
            if (manifest.mascot && manifest.mascot.path) {
              const mascotSource = path.join('/tmp/branding-assets', manifest.mascot.path);
              const mascotTarget = path.join('application/public/brand', manifest.mascot.path);
              
              if (fs.existsSync(mascotSource)) {
                const targetDir = path.dirname(mascotTarget);
                if (!fs.existsSync(targetDir)) {
                  fs.mkdirSync(targetDir, { recursive: true });
                }
                fs.copyFileSync(mascotSource, mascotTarget);
                core.info(`âœ“ Copied mascot: ${manifest.mascot.path}`);
              }
            }
            
            // Save manifest for reference
            fs.writeFileSync(
              'application/src/data/brand/manifest.json',
              JSON.stringify(manifest, null, 2)
            );
            core.info('âœ“ Saved manifest');
        env:
          MANIFEST: ${{ steps.parse-manifest.outputs.manifest }}

      - name: Generate brand content (colors, mission, guidelines)
        uses: ./.github/actions/generate-brand-content
        with:
          manifest: ${{ steps.parse-manifest.outputs.manifest }}
          output-dir: 'application/src/data/brand'

      - name: Create logo pack
        uses: ./.github/actions/create-logo-pack

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'application/package-lock.json'

      - name: Install dependencies
        run: |
          cd application
          npm ci

      - name: Generate brand guidelines PDF
        uses: ./.github/actions/generate-brand-pdf
        with:
          page-url: 'http://localhost:4321/charte-graphique'
          output-file: 'application/public/brand/downloads/hoverkraft-brand-guidelines.pdf'
          working-directory: 'application'

      - name: Validate updated assets
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const missingAssets = [];
            
            const requiredFiles = [
              'application/src/data/brand/generated-colors.ts',
              'application/src/data/brand/generated-mission.ts',
              'application/src/data/brand/generated-guidelines.ts',
              'application/public/brand/downloads/hoverkraft-logos.zip',
              'application/public/brand/downloads/hoverkraft-brand-guidelines.pdf'
            ];
            
            requiredFiles.forEach(file => {
              if (!fs.existsSync(file)) {
                missingAssets.push(file);
              }
            });
            
            // Check for at least one logo
            const logoDir = 'application/public/brand/logo';
            if (!fs.existsSync(logoDir) || fs.readdirSync(logoDir).length === 0) {
              missingAssets.push('logos');
            }
            
            if (missingAssets.length > 0) {
              core.setFailed(`Missing required branding assets: ${missingAssets.join(', ')}`);
            } else {
              core.info('âœ“ All required branding assets are present');
            }

      - name: Create pull request with updated assets
        uses: hoverkraft-tech/ci-github-common/actions/create-and-merge-pull-request@45440f67c2a87d63ba7b99f7ae3ea5b0e1c2f6a3 # v1.2.0
        with:
          branch-name: 'branding-update-${{ steps.parse-manifest.outputs.version }}'
          commit-message: |
            chore: update branding assets to version ${{ steps.parse-manifest.outputs.version }}
            
            Branding repository commit: ${{ steps.parse-manifest.outputs.commit }}
            Artifact ID: ${{ steps.parse-manifest.outputs.artifact_id }}
          pr-title: 'chore: update branding assets to v${{ steps.parse-manifest.outputs.version }}'
          pr-body: |
            ## Branding Assets Updated ðŸŽ¨
            
            **Version:** ${{ steps.parse-manifest.outputs.version }}
            **Branding Commit:** `${{ steps.parse-manifest.outputs.commit }}`
            **Artifact ID:** ${{ steps.parse-manifest.outputs.artifact_id }}
            
            ### Assets Updated
            - âœ… Brand colors (from manifest)
            - âœ… Brand mission statement
            - âœ… Usage guidelines
            - âœ… Logo files
            - âœ… Logo pack (ZIP)
            - âœ… Brand guidelines PDF (generated)
            - âœ… Mascot image
            
            ### Next Steps
            The brand guidelines pages will be updated with the new assets on the next deployment.
          auto-merge: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          VERSION: ${{ steps.parse-manifest.outputs.version }}
          COMMIT: ${{ steps.parse-manifest.outputs.commit }}
          ARTIFACT_ID: ${{ steps.parse-manifest.outputs.artifact_id }}
        with:
          script: |
            await core.summary
              .addHeading('Branding Assets Updated âœ…', 2)
              .addTable([
                [{data: 'Version', header: true}, process.env.VERSION],
                [{data: 'Branding Commit', header: true}, `\`${process.env.COMMIT}\``],
                [{data: 'Artifact ID', header: true}, process.env.ARTIFACT_ID]
              ])
              .addHeading('Assets Updated', 3)
              .addList([
                'âœ… Brand colors (from manifest)',
                'âœ… Brand mission statement',
                'âœ… Usage guidelines',
                'âœ… Logo files',
                'âœ… Logo pack (ZIP)',
                'âœ… Brand guidelines PDF (generated)',
                'âœ… Mascot image'
              ])
              .addHeading('Next Steps', 3)
              .addRaw('The brand guidelines pages will be updated with the new assets on the next deployment.')
              .write();
