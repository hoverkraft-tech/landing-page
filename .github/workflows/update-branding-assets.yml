# This workflow is triggered by the branding repository via repository dispatch when new branding data is available.
# It receives a manifest, downloads the assets, and updates the landing page accordingly.
---
name: Update Branding Assets

on:
  repository_dispatch:
    types: [branding-update]
  workflow_dispatch:
    inputs:
      artifact-id:
        description: "GitHub artifact ID containing branding assets"
        required: true
        type: string
      manifest:
        description: "JSON manifest describing the branding data"
        required: true
        type: string

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  update-branding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Parse inputs
        id: parse-inputs
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            let manifest, artifactId;

            if (context.eventName === 'repository_dispatch') {
              manifest = context.payload.client_payload.manifest;
              artifactId = context.payload.client_payload.artifact_id;
            } else {
              manifest = JSON.parse(process.env.MANIFEST_INPUT);
              artifactId = process.env.ARTIFACT_ID_INPUT;
            }

            core.setOutput('manifest', JSON.stringify(manifest));
            core.setOutput('artifact_id', artifactId);

            core.info(`ðŸ“¦ Branding update received:`);
            core.info(`  Version: ${manifest.version}`);
            core.info(`  Commit: ${manifest.commit}`);
            core.info(`  Artifact ID: ${artifactId}`);
        env:
          MANIFEST_INPUT: ${{ inputs.manifest }}
          ARTIFACT_ID_INPUT: ${{ inputs.artifact-id }}

      - name: Validate and parse manifest
        id: validate-manifest
        uses: ./.github/actions/validate-manifest
        with:
          manifest: ${{ steps.parse-inputs.outputs.manifest }}

      - name: Download and organize branding assets
        uses: ./.github/actions/download-branding-assets
        with:
          artifact-id: ${{ steps.validate-manifest.outputs.artifact-id }}
          version: ${{ steps.validate-manifest.outputs.version }}
          commit: ${{ steps.validate-manifest.outputs.commit }}
          logos: ${{ steps.validate-manifest.outputs.logos }}
          mascot: ${{ steps.validate-manifest.outputs.mascot }}

      - name: Generate brand content (colors, mission, guidelines, typography, logos)
        uses: ./.github/actions/generate-brand-content
        with:
          version: ${{ steps.validate-manifest.outputs.version }}
          commit: ${{ steps.validate-manifest.outputs.commit }}
          colors: ${{ steps.validate-manifest.outputs.colors }}
          brand-mission: ${{ steps.validate-manifest.outputs.brand-mission }}
          usage-guidelines: ${{ steps.validate-manifest.outputs.usage-guidelines }}
          logos: ${{ steps.validate-manifest.outputs.logos }}
          fonts: ${{ steps.validate-manifest.outputs.fonts }}
          output-dir: "application/src/data/brand"

      - name: Create logo pack
        uses: ./.github/actions/create-logo-pack
        with:
          logos-dir: "application/public/brand/logo"
          output-file: "application/public/brand/downloads/hoverkraft-logos.zip"

      - name: Generate brand guidelines PDF
        uses: ./.github/actions/generate-brand-pdf
        with:
          page-url: "http://localhost:4321/charte-graphique"
          output-file: "application/public/brand/downloads/hoverkraft-brand-guidelines.pdf"
          working-directory: "application"

      - name: Create pull request with updated assets
        uses: hoverkraft-tech/ci-github-common/actions/create-and-merge-pull-request@5f11437c716059f30c635f90055060e4ef8b31a0 # 0.28.0
        with:
          branch: "branding-update-${{ steps.validate-manifest.outputs.version }}"
          commit-message: |
            chore: update branding assets to version ${{ steps.validate-manifest.outputs.version }}

            Branding repository commit: ${{ steps.validate-manifest.outputs.commit }}
            Artifact ID: ${{ steps.validate-manifest.outputs.artifact-id }}
          title: "chore: update branding assets to v${{ steps.validate-manifest.outputs.version }}"
          body: |
            ## Branding Assets Updated ðŸŽ¨

            **Version:** ${{ steps.validate-manifest.outputs.version }}
            **Branding Commit:** `${{ steps.validate-manifest.outputs.commit }}`
            **Artifact ID:** ${{ steps.validate-manifest.outputs.artifact-id }}

            ### Assets Updated
            - âœ… Brand colors (from manifest)
            - âœ… Brand mission statement
            - âœ… Usage guidelines
            - âœ… Typography tokens
            - âœ… Logo assets metadata
            - âœ… Logo files
            - âœ… Logo pack (ZIP)
            - âœ… Brand guidelines PDF (generated)
            - âœ… Mascot image

            ### Next Steps
            The brand guidelines pages will be updated with the new assets on the next deployment.
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          VERSION: ${{ steps.validate-manifest.outputs.version }}
          COMMIT: ${{ steps.validate-manifest.outputs.commit }}
          ARTIFACT_ID: ${{ steps.validate-manifest.outputs.artifact-id }}
        with:
          script: |
            await core.summary
              .addHeading('Branding Assets Updated âœ…', 2)
              .addTable([
                [{data: 'Version', header: true}, process.env.VERSION],
                [{data: 'Branding Commit', header: true}, `\`${process.env.COMMIT}\``],
                [{data: 'Artifact ID', header: true}, process.env.ARTIFACT_ID]
              ])
              .addHeading('Assets Updated', 3)
              .addList([
                'âœ… Brand colors (from manifest)',
                'âœ… Brand mission statement',
                'âœ… Usage guidelines',
                'âœ… Typography tokens',
                'âœ… Logo assets metadata',
                'âœ… Logo files',
                'âœ… Logo pack (ZIP)',
                'âœ… Brand guidelines PDF (generated)',
                'âœ… Mascot image'
              ])
              .addHeading('Next Steps', 3)
              .addRaw('The brand guidelines pages will be updated with the new assets on the next deployment.')
              .write();
