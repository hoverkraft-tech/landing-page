name: Update Branding Assets

# This workflow is triggered by the branding repository via repository dispatch
# when new branding data is available. It receives a manifest and artifact ID,
# downloads the assets, and updates the landing page accordingly.

on:
  repository_dispatch:
    types: [branding-update]
  workflow_dispatch:
    inputs:
      artifact-id:
        description: 'GitHub artifact ID containing branding assets'
        required: true
        type: string
      manifest:
        description: 'JSON manifest describing the branding data'
        required: true
        type: string

permissions:
  contents: write
  actions: read

jobs:
  update-branding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Parse manifest from dispatch
        id: parse-manifest
        run: |
          # Get manifest from repository dispatch payload or workflow input
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            MANIFEST='${{ toJson(github.event.client_payload.manifest) }}'
            ARTIFACT_ID='${{ github.event.client_payload.artifact_id }}'
          else
            MANIFEST='${{ inputs.manifest }}'
            ARTIFACT_ID='${{ inputs.artifact-id }}'
          fi
          
          echo "manifest=$MANIFEST" >> $GITHUB_OUTPUT
          echo "artifact_id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
          
          # Validate manifest has required fields
          VERSION=$(echo "$MANIFEST" | jq -r '.version')
          COMMIT=$(echo "$MANIFEST" | jq -r '.commit')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Branding update received:"
          echo "  Version: $VERSION"
          echo "  Commit: $COMMIT"
          echo "  Artifact ID: $ARTIFACT_ID"

      - name: Validate manifest against schema
        run: |
          # Install ajv-cli for JSON schema validation
          npm install -g ajv-cli
          
          # Validate the manifest
          echo '${{ steps.parse-manifest.outputs.manifest }}' | \
            ajv validate -s .github/schemas/branding-manifest.schema.json -d -
          
          echo "âœ“ Manifest validation passed"

      - name: Download branding artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: branding-assets-${{ steps.parse-manifest.outputs.artifact_id }}
          path: /tmp/branding-assets
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: hoverkraft-tech/branding
          run-id: ${{ steps.parse-manifest.outputs.artifact_id }}

      - name: Extract and organize assets
        run: |
          MANIFEST='${{ steps.parse-manifest.outputs.manifest }}'
          
          # Create target directories
          mkdir -p application/src/data/brand
          mkdir -p application/public/brand/logos
          mkdir -p application/public/brand/mascot
          mkdir -p application/public/brand/downloads
          
          # Generate colors TypeScript file from manifest
          echo "$MANIFEST" | jq -r '.colors' > /tmp/colors.json
          cat > application/src/data/brand/generated-colors.ts << 'COLORS_EOF'
/**
 * Auto-generated brand colors from branding repository
 * DO NOT EDIT - This file is generated during the build process
 * Source: @hoverkraft-tech/branding
 */

export interface ColorToken {
  name: string;
  hex: string;
  rgb: string;
  usage: string;
}

COLORS_EOF
          echo "export const brandColors: ColorToken[] = $(cat /tmp/colors.json);" >> application/src/data/brand/generated-colors.ts
          echo "âœ“ Generated colors from manifest"
          
          # Copy logos based on manifest paths
          echo "$MANIFEST" | jq -r '.logos[].path' | while read -r logo_path; do
            if [ -f "/tmp/branding-assets/$logo_path" ]; then
              # Create directory if needed
              mkdir -p "application/public/brand/$(dirname "$logo_path")"
              cp "/tmp/branding-assets/$logo_path" "application/public/brand/$logo_path"
              echo "âœ“ Copied logo: $logo_path"
            else
              echo "::warning::Logo file not found: $logo_path"
            fi
          done
          
          # Copy mascot (if present)
          MASCOT_FILE=$(echo "$MANIFEST" | jq -r '.mascot.file // empty')
          if [ -n "$MASCOT_FILE" ] && [ -f "/tmp/branding-assets/$MASCOT_FILE" ]; then
            mkdir -p "application/public/brand/$(dirname "$MASCOT_FILE")"
            cp "/tmp/branding-assets/$MASCOT_FILE" "application/public/brand/$MASCOT_FILE"
            echo "âœ“ Copied mascot: $MASCOT_FILE"
          fi
          
          # Save manifest for reference
          echo "$MANIFEST" > application/src/data/brand/manifest.json
          echo "âœ“ Saved manifest"

      - name: Create logo pack
        uses: ./.github/actions/create-logo-pack

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'application/package-lock.json'

      - name: Install dependencies
        run: |
          cd application
          npm ci

      - name: Generate brand guidelines PDF
        uses: ./.github/actions/generate-brand-pdf
        with:
          page-url: 'http://localhost:4321/charte-graphique'
          output-file: 'application/public/brand/downloads/hoverkraft-brand-guidelines.pdf'
          working-directory: 'application'

      - name: Validate updated assets
        run: |
          echo "Validating branding assets..."
          
          MISSING_ASSETS=()
          
          # Check for generated colors
          if [ ! -f "application/src/data/brand/generated-colors.ts" ]; then
            MISSING_ASSETS+=("generated-colors.ts")
          fi
          
          # Check for at least one logo
          if [ ! -d "application/public/brand/logo" ] || [ -z "$(find application/public/brand/logo -type f)" ]; then
            MISSING_ASSETS+=("logos")
          fi
          
          # Check for logo pack
          if [ ! -f "application/public/brand/downloads/hoverkraft-logos.zip" ]; then
            MISSING_ASSETS+=("hoverkraft-logos.zip")
          fi
          
          # Check for generated PDF
          if [ ! -f "application/public/brand/downloads/hoverkraft-brand-guidelines.pdf" ]; then
            MISSING_ASSETS+=("hoverkraft-brand-guidelines.pdf")
          fi
          
          if [ ${#MISSING_ASSETS[@]} -gt 0 ]; then
            echo "::error::Missing required branding assets: ${MISSING_ASSETS[*]}"
            exit 1
          fi
          
          echo "âœ“ All required branding assets are present"

      - name: Commit updated assets
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add application/public/brand/
          git add application/src/data/brand/manifest.json
          git add application/src/data/brand/generated-colors.ts
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update branding assets to version ${{ steps.parse-manifest.outputs.version }}

Branding repository commit: ${{ steps.parse-manifest.outputs.commit }}
Artifact ID: ${{ steps.parse-manifest.outputs.artifact_id }}"
            
            git push
            echo "âœ“ Changes committed and pushed"
          fi

      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Branding Assets Updated âœ…
          
          **Version:** ${{ steps.parse-manifest.outputs.version }}
          **Branding Commit:** `${{ steps.parse-manifest.outputs.commit }}`
          **Artifact ID:** ${{ steps.parse-manifest.outputs.artifact_id }}
          
          ### Assets Updated
          - âœ“ Brand colors (from manifest)
          - âœ“ Logo files
          - âœ“ Logo pack (ZIP)
          - âœ“ Brand guidelines PDF (generated)
          - âœ“ Mascot image
          
          ### Next Steps
          The brand guidelines pages will be updated with the new assets on the next deployment.
          EOF
