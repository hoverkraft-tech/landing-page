# Workflow to update branding assets in the landing-page repository upon receiving a dispatch event from the branding repository.
#
# - Branding repository packages validated assets, emits manifest, and dispatches `branding-update` with `artifact_id` matching the GitHub run ID.
# - Landing-page workflow validates the manifest, downloads `branding-assets-<run_id>` from `hoverkraft-tech/branding`, and refreshes assets plus derived outputs (logo ZIP, brand guide PDF).
#
# Manifest fields capture version metadata, color tokens, logo inventory, mascot path, and typography tokens and must satisfy `.github/schemas/branding-manifest.schema.json`.

---
name: Update Branding Assets

on:
  repository_dispatch:
    types: [branding-update]
  workflow_dispatch:
    inputs:
      #checkov:skip=CKV_GHA_7: required
      manifest:
        description: |
          JSON manifest describing the branding data (artifact-id comes from manifest)
        required: true
        type: string

permissions:
  contents: write
  actions: read
  pull-requests: write

env:
  APPLICATION_DIR: application
  BRAND_DIR: application/src/data/brand
  BRAND_LOGO_DIR: application/public/brand/logo
  BRAND_DOWNLOADS_DIR: application/public/brand/downloads
  BRAND_LOGO_PACK_FILE: application/public/brand/downloads/hoverkraft-logos.zip
  BRAND_GUIDELINES_BASE_URL: http://localhost:4321
  BRAND_GUIDELINES_DEFAULT_SLUG: brand-guidelines
  BRAND_GUIDELINES_ROUTES_FILE: application/src/i18n/ui.ts

jobs:
  update-branding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Parse inputs
        id: parse-inputs
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          MANIFEST_INPUT: ${{ inputs.manifest }}
        with:
          script: |
            let manifest;

            if (context.eventName === 'repository_dispatch') {
              manifest = context.payload.client_payload.manifest;
            } else {
              manifest = JSON.parse(process.env.MANIFEST_INPUT);
            }

            core.setOutput('manifest', JSON.stringify(manifest));

            core.info('ðŸ“¦ Branding update received:');
            core.info(`  Version: ${manifest.version}`);
            core.info(`  Commit: ${manifest.commit}`);
            core.info(`  Artifact ID: ${manifest.artifactId}`);

      - name: Validate and parse manifest
        id: validate-manifest
        uses: ./.github/actions/validate-manifest
        with:
          manifest: ${{ steps.parse-inputs.outputs.manifest }}

      - name: Download and organize branding assets
        uses: ./.github/actions/download-branding-assets
        with:
          artifact-id: ${{ steps.validate-manifest.outputs.artifact-id }}
          version: ${{ steps.validate-manifest.outputs.version }}
          commit: ${{ steps.validate-manifest.outputs.commit }}
          logos: ${{ steps.validate-manifest.outputs.logos }}
          mascot: ${{ steps.validate-manifest.outputs.mascot }}

      - name: Generate brand content (mission, colors, typography, logos)
        uses: ./.github/actions/generate-brand-content
        with:
          version: ${{ steps.validate-manifest.outputs.version }}
          commit: ${{ steps.validate-manifest.outputs.commit }}
          colors: ${{ steps.validate-manifest.outputs.colors }}
          brand-mission: ${{ steps.validate-manifest.outputs.brand-mission }}
          logos: ${{ steps.validate-manifest.outputs.logos }}
          typography: ${{ steps.validate-manifest.outputs.typography }}
          output-dir: ${{ env.BRAND_DIR }}

      - name: Create logo pack
        uses: ./.github/actions/create-logo-pack
        with:
          logos-dir: ${{ env.BRAND_LOGO_DIR }}
          output-file: ${{ env.BRAND_LOGO_PACK_FILE }}

      - name: Generate brand guidelines PDFs
        id: generate-brand-pdfs
        uses: ./.github/actions/generate-brand-pdfs
        with:
          locales: ${{ steps.validate-manifest.outputs.locales }}
          default-slug: ${{ env.BRAND_GUIDELINES_DEFAULT_SLUG }}
          routes-file: ${{ env.BRAND_GUIDELINES_ROUTES_FILE }}
          base-url: ${{ env.BRAND_GUIDELINES_BASE_URL }}
          downloads-dir: ${{ env.BRAND_DOWNLOADS_DIR }}
          working-directory: ${{ env.APPLICATION_DIR }}

      - name: Create pull request with updated assets
        uses: hoverkraft-tech/ci-github-common/actions/create-and-merge-pull-request@5f11437c716059f30c635f90055060e4ef8b31a0 # 0.28.0
        with:
          branch: branding-update-${{ steps.validate-manifest.outputs.version }}
          commit-message: |
            chore: update branding assets to version ${{ steps.validate-manifest.outputs.version }}

            Branding repository commit: ${{ steps.validate-manifest.outputs.commit }}
            Artifact ID: ${{ steps.validate-manifest.outputs.artifact-id }}
          title: "chore: update branding assets to v${{ steps.validate-manifest.outputs.version }}"
          body: |
            ## Branding Assets Updated ðŸŽ¨

            **Version:** ${{ steps.validate-manifest.outputs.version }}
            **Branding Commit:** `${{ steps.validate-manifest.outputs.commit }}`
            **Artifact ID:** ${{ steps.validate-manifest.outputs.artifact-id }}

            ### Assets Updated (${{ steps.validate-manifest.outputs.locales }})
            - âœ… Brand colors (from manifest)
            - âœ… Brand mission statements
            - âœ… Typography tokens
            - âœ… Logo assets metadata (localized copy)
            - âœ… Logo files
            - âœ… Logo pack (ZIP)
            - âœ… Brand guidelines PDFs
            - âœ… Mascot image

            ### Next Steps
            The brand guidelines pages will be updated with the new assets on the next deployment.
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          VERSION: ${{ steps.validate-manifest.outputs.version }}
          COMMIT: ${{ steps.validate-manifest.outputs.commit }}
          ARTIFACT_ID: ${{ steps.validate-manifest.outputs.artifact-id }}
          LOCALES: ${{ steps.validate-manifest.outputs.locales }}
        with:
          script: |
            await core.summary
              .addHeading('Branding Assets Updated âœ…', 2)
              .addTable([
                [{ data: 'Version', header: true }, process.env.VERSION],
                [{ data: 'Branding Commit', header: true }, `\`${process.env.COMMIT}\``],
                [{ data: 'Artifact ID', header: true }, process.env.ARTIFACT_ID],
                [{ data: 'Locales', header: true }, process.env.LOCALES]
              ])
              .addHeading('Assets Updated', 3)
              .addList([
                'âœ… Brand colors (from manifest)',
                `âœ… Brand mission statements`,
                'âœ… Typography tokens',
                'âœ… Logo assets metadata (localized copy)',
                'âœ… Logo files',
                'âœ… Logo pack (ZIP)',
                `âœ… Brand guidelines PDFs`,
                'âœ… Mascot image'
              ])
              .addHeading('Next Steps', 3)
              .addRaw('The brand guidelines pages will be updated with the new assets on the next deployment.')
              .write()
