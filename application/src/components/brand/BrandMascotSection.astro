---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import type { BrandLocale, MascotAsset } from '~/data/brand/tokens';

interface Props {
  lang: BrandLocale;
  mascot: MascotAsset;
  title: string;
  description: string;
  usageLabel: string;
  formatsLabel: string;
}

const { lang, mascot, title, description, usageLabel, formatsLabel } = Astro.props as Props;
const localizedName = mascot?.name?.[lang] ?? mascot?.name?.fr ?? mascot?.name?.en ?? '';
const localizedUsage = mascot?.usage?.[lang] ?? mascot?.usage?.fr ?? mascot?.usage?.en ?? '';
const mascotFormats = Object.entries(mascot?.formats ?? {});
const readableMascotName = localizedName || title || 'Mascot asset';
const downloadLinkLabelByLocale: Record<BrandLocale, string> = {
  en: 'Download',
  fr: 'Télécharger',
};
const downloadLinkLabel = downloadLinkLabelByLocale[lang] ?? downloadLinkLabelByLocale.en;

if (!mascotFormats.length) {
  throw new Error(`Mascot "${readableMascotName}" must define at least one format.`);
}

const [primaryFormat, primaryPathRaw] = mascotFormats[0] ?? [];

if (typeof primaryPathRaw !== 'string' || primaryPathRaw.length === 0) {
  throw new Error(
    `Mascot "${readableMascotName}" primary format "${primaryFormat ?? 'unknown'}" is missing a valid asset path.`
  );
}

const mascotAssetModules = import.meta.glob<ImageMetadata>('~/assets/images/brand/**/*.{png,svg,webp}', {
  eager: true,
  import: 'default',
});

const mascotAssetMap = new Map<string, ImageMetadata>();

for (const [fullPath, metadata] of Object.entries(mascotAssetModules)) {
  const normalizedPath = fullPath.split('/assets/images/brand/')[1];

  if (normalizedPath && metadata) {
    mascotAssetMap.set(normalizedPath, metadata);
  }
}

const normalizeAssetPath = (rawPath: string) => rawPath.replace(/^\.\//, '').replace(/^\//, '');
const normalizedPrimaryPath = normalizeAssetPath(primaryPathRaw);
const mascotAssetMetadata = mascotAssetMap.get(normalizedPrimaryPath);

if (!mascotAssetMetadata) {
  throw new Error(
    `Mascot "${readableMascotName}" asset file "${primaryPathRaw}" was not found under assets/images/brand.`
  );
}

const mascotAsset = mascotAssetMetadata;

const mascotDownloads = mascotFormats.map(([format, path]) => {
  if (typeof path !== 'string' || path.length === 0) {
    throw new Error(`Mascot "${readableMascotName}" format "${format}" is missing a valid asset path.`);
  }

  const normalizedPath = normalizeAssetPath(path);
  const uppercaseFormat = format.toUpperCase();

  return {
    format,
    href: `/${normalizedPath}`,
    text: `${downloadLinkLabel} ${uppercaseFormat}`.trim(),
    ariaLabel: `${downloadLinkLabel} ${readableMascotName} (${uppercaseFormat})`,
  };
});
---

<div class="mb-16">
  <h2 class="text-3xl md:text-4xl font-bold mb-8 text-gray-900 dark:text-white">{title}</h2>
  <div class="grid lg:grid-cols-[2fr,3fr] gap-8 items-center">
    <div
      class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-8 flex flex-col items-center justify-center min-h-[280px] gap-6"
    >
      <Image
        src={mascotAsset}
        alt={localizedName || title}
        width={360}
        height={360}
        loading="lazy"
        decoding="async"
        class="w-full max-w-sm h-auto"
      />
      {
        mascotDownloads.length ? (
          <div class="w-full text-sm text-gray-600 dark:text-gray-400">
            <p>
              <strong>{formatsLabel}</strong>
            </p>
            <ul class="mt-2 space-y-1">
              {mascotDownloads.map((download) => (
                <li>
                  <a
                    href={download.href}
                    download
                    aria-label={download.ariaLabel}
                    title={download.ariaLabel}
                    class="text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300"
                  >
                    {download.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ) : null
      }
    </div>
    <div class="space-y-4">
      {localizedName ? <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">{localizedName}</h3> : null}
      <p class="text-gray-700 dark:text-gray-300">{description}</p>
      {
        localizedUsage ? (
          <div class="bg-gray-50 dark:bg-gray-900/70 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
            <h4 class="text-sm font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-400">{usageLabel}</h4>
            <p class="mt-2 text-gray-700 dark:text-gray-300">{localizedUsage}</p>
          </div>
        ) : null
      }
    </div>
  </div>
</div>
